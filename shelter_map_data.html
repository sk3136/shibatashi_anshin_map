<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="shortcut icon" href="https://cyberjapandata.gsi.go.jp/favicon.ico" />

<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>新発田市避難所マップ</title>

<script type="text/javascript" src="database.js"></script>
<script type="text/javascript">
    function search() {
        navigator.geolocation.getCurrentPosition((position)=> {
            //緯度
            const lat = position.coords.latitude;
            //経度
            const lng = position.coords.longitude;
            Init(lat, lng);
        });
    }

    var oMap      = null;

    function Init(lat_now, lng_now) {
        var vURL      = "https://maps.gsi.go.jp";
        var vURL_Site = "/index_pm.html?postmessage=1#16/" + lat_now + "/" + lng_now + "/&base=std&ls=std&disp=1&vs=c1g1j0h0k0l0u0t0z0r0s0m0f1";
        oMap = document.createElement("iframe");
        oMap.style.display = "none";

        EvtResize();
        oMap.src = vURL + vURL_Site;
        oMap.onload = function(){
            var oContent   = oMap.contentWindow;
            var ClientMode = {
                baseUrl     : null
                , location    : null
                , LayerJS     : null
                , sakuzuList  : null
                , queryString : null
            };
            var nearby = 0;
            var nearby_list = [];
            for (var i = 0; i < shelter_name.length; i++) {
                // sqrt 平方根　pow n乗 (元の数値,指数)
                if (Math.sqrt(Math.pow(lat_now - shelter_lat[i], 2) + Math.pow(lng_now - shelter_lng[i], 2)) < nearby || i == 0) {
                    nearby = Math.sqrt(Math.pow(lat_now - shelter_lat[i], 2) + Math.pow(lng_now - shelter_lng[i], 2));
                    nearby_list = [];
                    nearby_list.push(i);
                } else if (Math.sqrt(Math.pow(lat_now - shelter_lat[i], 2) + Math.pow(lng_now - shelter_lng[i], 2)) == nearby) {
                    nearby_list.push(i);
                }
            }
            var template = [];
            for (var i = 0; i < shelter_name.length + 1; i++) {
                if (i == shelter_name.length) {
                    template.push({"fileName":"","visible":true,"features":[{"type":"Feature","properties":{"name":'現在地',"_markerType":"Icon","_iconUrl":"https://maps.gsi.go.jp/portal/sys/v4/symbols/082.png","_iconSize":[20,20],"_iconAnchor":[10,10]},"geometry":{"type":"Point","coordinates":[lng_now,lat_now]}}]}, {"fileName":"","visible":true,"features":[{"type":"Feature","properties":{"_markerType":"DivIcon","_html":"<div style=\"font-size:9.5pt;color:#000000;background-color:#ffffff;\">現在地</div>"},"geometry":{"type":"Point","coordinates":[lng_now,lat_now]}}]});
                } else {
                    for (var j = 0; j < nearby_list.length; j++) {
                        if (i == nearby_list[j]) {
                            template.push({"fileName":"","visible":true,"features":[{"type":"Feature","properties":{"name":shelter_name[i],"_markerType":"Icon","_iconUrl":"https://maps.gsi.go.jp/portal/sys/v4/symbols/080.png","_iconSize":[20,20],"_iconAnchor":[10,10]},"geometry":{"type":"Point","coordinates":[shelter_lng[i],shelter_lat[i]]}}]}, {"fileName":"","visible":true,"features":[{"type":"Feature","properties":{"_markerType":"DivIcon","_html":"<div style=\"font-size:9.5pt;color:#000000;background-color:#ffffff;\">" + shelter_name[i] + "</div>"},"geometry":{"type":"Point","coordinates":[shelter_lng[i],shelter_lat[i]]}}]});
                        } else {
                            template.push({"fileName":"","visible":true,"features":[{"type":"Feature","properties":{"name":shelter_name[i],"_markerType":"Icon","_iconUrl":"https://maps.gsi.go.jp/portal/sys/v4/symbols/081.png","_iconSize":[20,20],"_iconAnchor":[10,10]},"geometry":{"type":"Point","coordinates":[shelter_lng[i],shelter_lat[i]]}}]}, {"fileName":"","visible":true,"features":[{"type":"Feature","properties":{"_markerType":"DivIcon","_html":"<div style=\"font-size:9.5pt;color:#000000;background-color:#ffffff;\">" + shelter_name[i] + "</div>"},"geometry":{"type":"Point","coordinates":[shelter_lng[i],shelter_lat[i]]}}]});
                        }
                    }
                }
            }
            ClientMode.sakuzuList = template;

            oContent.postMessage(ClientMode, vURL);
        };
        showWindow('topDiv');
        document.body.appendChild(oMap);
    };

    function EvtResize(){
        var w = window.innerWidth;
        var h = window.innerHeight;
        if(oMap != null){
            oMap.style.width   = w + "px";
            oMap.style.height  = h + "px";
            if(oMap.style.display == "none"){
                oMap.style.display = "block";
            }
        }
    };

    function showWindow(divId) {
        document.getElementById(divId).style.visibility = "visible";
    }

    function closeWindow(divId) {
        document.getElementById(divId).style.visibility = "hidden";
    }

    function window_change() {
        document.getElementById("openTop").addEventListener("click", () => {
            closeWindow("hideDiv");
            showWindow("topDiv");
        });
        document.getElementById("closeTop").addEventListener("click", () => {
            closeWindow("topDiv");
            showWindow("hideDiv");
        });
    }

    window.onload   = function(){
        document.body.style.margin   = "0px";
        document.body.style.padding  = "0px";
        document.body.style.overflow = "hidden";
        search();
        window_change();
    }
    window.onresize = EvtResize;
</script>
<style>
p {
    margin: auto;
    padding: 3px;
    font-size: 15px;
}
.closeCircle {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 16px;
    line-height: 18px;
    text-align: center;
    position: absolute;
    right: 3px;
    top: 2px;
}
.openCircle {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 16px;
    line-height: 18px;
    text-align: center;
    position: absolute;
    right: 3px;
    top: 2px;
}
#topDiv .closeCircle {
    background-color: orange;
}
#hideDiv .openCircle {
    background-color: orange;
}
#topDiv {
    visibility: hidden;
    background-color:rgba(255, 190, 190, 0.7);
    position: absolute;
    width: 190px;
    height: 75px;
    top: 80%;
    right: 20%;
}
#hideDiv {
    visibility: hidden;
    text-align: left;
    background-color:rgba(255, 190, 190, 0.7);
    position: absolute;
    padding-left: 5px;
    width: 60px;
    height: 25px;
    top: 80%;
    right: 20%;
}
</style>
</head>
<body style="text-align: center;">
    <div id="topDiv">
        <div class="closeCircle" id="closeTop">-</div>
        <p>緑➝現在地<br>赤➝最寄りの避難所<br>青➝その他の避難所</p>
    </div>
    <div id="hideDiv">
        <div class="openCircle" id="openTop">+</div>
        <p>説明</p>
    </div>
</body>
</html>